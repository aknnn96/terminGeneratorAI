<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI Termin-Detektiv Interaktiv V18.0 (Final Fix)</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
    html, body { height: 100%; margin: 0; }
    body { font-family: 'Inter', sans-serif; background-color: #f7f7f7; }

    .chat-container { display:flex; flex-direction:column; height:100vh; max-height:100vh; overflow:hidden; }
    .chat-window { flex-grow:1; overflow-y:auto; scroll-behavior:smooth; padding:1rem; background-color:#fff; }
    .message-row { display:flex; margin-bottom:0.75rem; }
    .user-message-row { justify-content:flex-end; }
    .bot-message-row { justify-content:flex-start; }
    .message-content { display:flex; flex-direction:column; max-width:85%; }

    .message { padding:0.75rem 1rem; border-radius:1.5rem; line-height:1.4; word-wrap:break-word; font-size:0.95rem; box-shadow:0 1px 3px rgba(0,0,0,0.1); }
    .user-message { background-color:#DCF8C6; color:#1F2937; border-bottom-right-radius:0.375rem; }
    .bot-message { background-color:#E5E7EB; color:#1F2937; border-bottom-left-radius:0.375rem; }
    .system-message { background-color:#FEE2E2; color:#7F1D1D; border-bottom-left-radius:0.375rem; }

    .extraction-block { background:#F9FAFB; border:1px solid #D1D5DB; padding:1rem; margin-top:0.75rem; border-radius:0.75rem; box-shadow:0 2px 4px rgba(0,0,0,0.05); font-size:0.9rem; }
    .extraction-block strong { color:#4338CA; }

    .loading-dots div { width:10px; height:10px; background-color:#4B5563; border-radius:50%; display:inline-block; margin:0 2px; animation:bounce 0.6s infinite alternate; }
    .loading-dots div:nth-child(2){ animation-delay:0.2s; }
    .loading-dots div:nth-child(3){ animation-delay:0.4s; }
    @keyframes bounce { from{ transform:translateY(0);} to{ transform:translateY(-5px);} }

    .interactive-buttons { display:flex; flex-wrap:wrap; gap:8px; margin-top:1rem; padding-top:0.5rem; } 
    .interactive-button {
      display:flex; align-items:center; justify-content:center; gap:8px; 
      background:#10B981; color:#fff; padding:10px 14px; border-radius:0.75rem; font-size:0.9rem; font-weight:600;
      cursor:pointer; transition:background-color .2s, transform .05s; box-shadow:0 1px 3px rgba(0,0,0,0.15);
      flex-basis: calc(33.333% - 8px); 
      min-width: 120px;
      text-align: center;
    }
    .interactive-buttons.full-width-options .interactive-button {
        flex-basis: 100%;
        text-align: left;
        justify-content: flex-start;
        padding-left: 1rem;
        padding-right: 1rem;
    }
    /* FIX V18.0: Visual für manuellen Input als grauer Hint */
    .interactive-button.manual-input {
      background:#F3F4F6; /* Very Light Grey */
      color: #4B5563; /* Darker Text */
      border: 1px dashed #9CA3AF; /* Dashed Border */
      box-shadow: none; /* No shadow */
      flex-basis: 100%;
    }
    .interactive-button.manual-input:hover { 
      background:#E5E7EB; /* Slightly darker hover */
      color: #1F2937;
    }
    .interactive-button:hover { background:#059669; }
    .interactive-button:active { transform:scale(0.99); }

    .calendar-actions { display:flex; flex-direction:column; gap:8px; margin-top:1rem; padding-top:1rem; border-top:1px dashed #D1D5DB; }
    .calendar-button { display:flex; align-items:center; justify-content:center; gap:8px; padding:12px; border-radius:0.75rem; font-weight:600; transition:background-color .2s, transform .05s; width:100%; }
    .calendar-button .material-icons { font-size:18px; line-height:1; vertical-align:middle; }
    .calendar-button:active { transform:scale(0.99); }
    .ics-button { background:#EF4444; color:#fff; }
    .ics-button:hover { background:#DC2626; }
    .google-button { background:#4285F4; color:#fff; }
    .google-button:hover { background:#3B7AEB; }

    .delete-button { 
        background-color: #F87171; 
        border-color: #EF4444; 
    }
    .delete-button:hover { 
        background-color: #EF4444; 
    }
  </style>
</head>
<body class="bg-gray-50">
  <div id="app" class="chat-container">
    <header class="bg-white shadow-md p-4 flex justify-end items-center sticky top-0 z-10 flex-shrink-0 gap-3">
      <h1 class="text-xl font-bold text-gray-800 flex items-center gap-2 mr-auto">
        <span class="material-icons text-indigo-600 align-middle" style="font-size:22px; line-height:1;">calendar_today</span>
        AI Termin-Detektiv
      </h1>
      
      <button id="clearChatButton"
        class="flex items-center justify-center gap-2 delete-button hover:bg-red-600 text-white font-semibold py-2 px-3 rounded-xl transition duration-150 ease-in-out shadow-lg text-sm">
        <span class="material-icons align-middle" style="font-size:18px; line-height:1;">delete_forever</span>
        <span>Chat Löschen</span>
      </button>

      <button id="downloadChatButton"
        class="flex items-center justify-center gap-2 bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-3 rounded-xl transition duration-150 ease-in-out shadow-lg text-sm">
        <span class="material-icons align-middle" style="font-size:18px; line-height:1;">download</span>
        <span>Chat Export</span>
      </button>
    </header>

    <div id="chatWindow" class="chat-window flex flex-col space-y-3"></div>

    <div id="loadingIndicator" class="hidden p-4 bg-white flex-shrink-0">
      <div class="bot-message-row">
        <div class="message bg-gray-200 text-gray-700 flex items-center">
          <div class="loading-dots flex"><div></div><div></div><div></div></div>
        </div>
      </div>
    </div>

    <div class="message-input-area p-4 bg-gray-100 border-t border-gray-200 flex-shrink-0">
      <div id="imagePreviewContainer" class="image-preview-container flex items-center justify-between mb-3 hidden">
        <div class="flex items-center space-x-3">
          <img id="image-preview" src="" alt="Bild-Vorschau" class="h-20 w-auto rounded-lg object-cover" />
          <span id="image-filename" class="text-sm text-gray-600 truncate max-w-xs"></span>
        </div>
        <button id="cancel-upload" class="flex items-center justify-center text-gray-600 hover:text-red-600 transition duration-150">
          <span class="material-icons align-middle" style="font-size:20px; line-height:1;">close</span>
        </button>
      </div>

      <div class="flex items-end space-x-3">
        <label for="fileInput" class="cursor-pointer text-gray-600 hover:text-indigo-600 transition duration-150 p-2 rounded-full hover:bg-gray-200 flex items-center justify-center">
          <span class="material-icons align-middle" style="font-size:28px; line-height:1;">image</span>
          <input type="file" id="fileInput" accept="image/*" class="hidden" />
        </label>

        <textarea id="userInput" placeholder="Termin-Details eingeben..." rows="1"
          class="flex-grow resize-none p-3 border border-gray-300 rounded-2xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 overflow-hidden"
          style="max-height:200px;"></textarea>

        <button id="sendButton" disabled
          class="flex items-center justify-center gap-2 bg-indigo-500 text-white p-3 rounded-full shadow-lg transition-all duration-300 disabled:bg-indigo-300 disabled:opacity-70 hover:bg-indigo-600">
          <span class="material-icons align-middle" style="font-size:18px; line-height:1;">send</span>
          <span class="hidden sm:inline">Senden</span>
        </button>
      </div>
    </div>
  </div>

  <script type="module">
    const API_ENDPOINT = "/.netlify/functions/gemini";
    const STORAGE_KEY = 'terminDetektivChatHistory'; 

    let chatHistory = [];
    let currentImageFile = null;
    let currentInteraction = null;

    let chatWindow, userInput, sendButton, downloadChatButton, clearChatButton, fileInput, imagePreviewContainer, loadingIndicator;

    function saveChatHistory(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(chatHistory)); }catch(e){ console.error(e); } }
    
    function loadChatHistory(){ 
      try{ 
        const s=localStorage.getItem(STORAGE_KEY); 
        if(s){ 
          chatHistory=JSON.parse(s); 
          renderChatHistory(); 
        } 
      }catch(e){ 
        console.error("Fehler beim Laden der History", e); 
      } 
    }

    function clearChatHistory(){
      if(confirm("Sind Sie sicher, dass Sie den Chatverlauf löschen möchten?")){
        localStorage.removeItem(STORAGE_KEY);
        chatHistory = [];
        renderChatHistory(); 
        const welcome = "Willkommen beim **AI Termin-Detektiv**! Das heutige Datum ist der **" + new Date().toLocaleDateString('de-DE') + "**. Senden Sie Text, einen Screenshot oder ein Foto; fehlende Details werden interaktiv abgefragt. Sie können jederzeit tippen oder die Vorschläge wählen.";
        addMessageToChat(welcome, 'model');
      }
    }

    function renderChatHistory(){
      if(!chatWindow) return;
      chatWindow.innerHTML='';
      currentInteraction=null;
      chatHistory.forEach(m=> chatWindow.appendChild(createMessageElement(m)));
      scrollToBottom();
      toggleSendButton();
    }

    // --- Kalender Hilfsfunktionen ---
    function durationToMinutes(d){ if(!d || d.includes('-') || d.includes('[FEHLT]')) return 60; const p=d.split(':'); return p.length===2 ? (+p[0])*60+(+p[1]) : 60; }
    function calculateEndTime(date,time,dur){
      if(!time || time.includes('-') || time.includes('[FEHLT]')) return date.replace(/-/g,'')+'T235959';
      const start=new Date(date+'T'+time+':00'); const end=new Date(start.getTime()+dur*60000);
      const y=end.getFullYear(), m=String(end.getMonth()+1).padStart(2,'0'), d_=String(end.getDate()).padStart(2,'0');
      const hh=String(end.getHours()).padStart(2,'0'), mm=String(end.getMinutes()).padStart(2,'0');
      return `${y}${m}${d_}T${hh}${mm}00`;
    }
    function createGoogleCalendarLink(data){
      const title=encodeURIComponent(data.Zweck||'Termin');
      const location=encodeURIComponent(data.Ort||'');
      const datePart=(data.Datum||'').replace(/-/g,''); const dur=durationToMinutes(data.Dauer||'-');
      let startDate,endDate;
      if(!data.Uhrzeit || data.Uhrzeit.includes('-') || data.Uhrzeit.includes('[FEHLT]')){ startDate=datePart; const s=new Date(data.Datum); const e=new Date(s); e.setDate(s.getDate()+1); endDate=e.toISOString().split('T')[0].replace(/-/g,''); }
      else { const st=data.Uhrzeit.replace(/:/g,'')+'00'; startDate=datePart+'T'+st; endDate=calculateEndTime(data.Datum,data.Uhrzeit,dur); }
      return `https://www.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${startDate}/${endDate}&location=${location}&sf=true&output=xml`;
    }
    function createICSContent(data){
      const uid=Date.now(); const now=new Date().toISOString().replace(/[-:]/g,'').split('.')[0]+'Z';
      const summary=data.Zweck||'Termin', location=data.Ort||'', datePart=(data.Datum||'').replace(/-/g,''), dur=durationToMinutes(data.Dauer||'-');
      let dtstart, dtend;
      if(!data.Uhrzeit || data.Uhrzeit.includes('-') || data.Uhrzeit.includes('[FEHLT]')){
        dtstart=`DTSTART;VALUE=DATE:${datePart}`;
        const s=new Date(data.Datum+'T00:00:00'); const e=new Date(s); e.setDate(s.getDate()+1);
        dtend=`DTEND;VALUE=DATE:${e.toISOString().split('T')[0].replace(/-/g,'')}`;
      } else {
        const st=data.Uhrzeit.replace(/:/g,'')+'00';
        const et=calculateEndTime(data.Datum,data.Uhrzeit,dur).split('T')[1];
        dtstart=`DTSTART:${datePart}T${st}`; dtend=`DTEND:${datePart}T${et}`;
      }
      return ['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//AI Termin-Detektiv//NONSGML v1.0//DE','BEGIN:VEVENT',`UID:${uid}@termin-detektiv.de`,`DTSTAMP:${now}`,dtstart,dtend,`SUMMARY:${summary}`,`LOCATION:${location}`,'END:VEVENT','END:VCALENDAR'].join('\r\n');
    }
    function downloadICS(c){ const blob=new Blob([c],{type:'text/calendar;charset=utf-8'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`termin_${Date.now()}.ics`; document.body.appendChild(a); a.click(); document.body.removeChild(a); }

    function scrollToBottom(){ if(!chatWindow) return; setTimeout(()=>{ chatWindow.scrollTop=chatWindow.scrollHeight; },10); }

    function toggleSendButton(){
      if(!sendButton||!userInput) return;
      const text=userInput.value.trim(); const hasImage=currentImageFile!==null; const hasInput=Boolean(text)||hasImage; 
      
      sendButton.disabled=!hasInput; 
      userInput.disabled=false; 
      
      userInput.placeholder=currentInteraction?'Bitte geben Sie hier Ihre Korrektur/Antwort ein oder wählen Sie oben eine Option...':'Termin-Details eingeben...';
    }
    // --- Ende Kalender Hilfsfunktionen ---

    function formatMarkdownToHtml(raw){
      let t = raw.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\*(.*?)\*/g,'<em>$1</em>');
      
      if(!t.includes('<INTERACTION>')){
        const loose = t.match(/\{[\s\S]*"interactionType"[\s\S]*\}/);
        if(loose){ t = t.replace(loose[0], `<INTERACTION>${loose[0]}</INTERACTION>`); }
      }
      
      const rx=/<EXTRACT>(.*?)<DATA>(.*?)<\/DATA><\/EXTRACT>/s; 
      const m=t.match(rx);
      
      if(m){
        const extraction=m[1].trim(); 
        const rawJson=m[2].trim();
        
        const pre=t.substring(0,m.index).trim().replace(/\n/g,'<br>'); 
        const post=t.substring(m.index+m[0].length).trim().replace(/\n/g,'<br>');
        
        let html=pre.replace(/<br>$/,'');
        let data=null; 
        try{ data=JSON.parse(rawJson); }catch(e){ console.error('DATA parse error', e); }
        
        const block=document.createElement('div'); block.className='extraction-block';
        
        // **WICHTIG:** Ersetzt [FEHLT] durch - für die Anzeige
        const content=extraction.replace(/\[FEHLT\]/g,'-').replace(/<br>/g,'\n').split('\n').filter(l=>l.trim().length>0).map(l=>`<div>${l}</div>`).join('');
        block.innerHTML=`<strong>Termin-Details:</strong><br>`+content;

        const ready = data && data.Datum && !data.Datum.includes('[FEHLT]') && data.Dauer && !data.Dauer.includes('[FEHLT]');
        if(ready){
          const actions=document.createElement('div'); actions.className='calendar-actions';
          const g=document.createElement('a'); g.href=createGoogleCalendarLink(data); g.target='_blank'; g.className='calendar-button google-button';
          g.innerHTML=`<span class="material-icons" style="font-size:18px;line-height:1;">event_available</span><span>Zum Google Kalender hinzufügen</span>`;
          const icsBtn=document.createElement('button'); icsBtn.className='calendar-button ics-button';
          icsBtn.innerHTML=`<span class="material-icons" style="font-size:18px;line-height:1;">download</span><span>ICS-Datei herunterladen</span>`;
          icsBtn.onclick=()=>downloadICS(createICSContent(data));
          actions.appendChild(g); actions.appendChild(icsBtn); block.appendChild(actions);
        } else if (data) {
          const hint=document.createElement('p'); hint.className='text-sm text-gray-500 mt-3 border-t border-gray-200 pt-3';
          hint.innerHTML='Bitte vervollständigen Sie die fehlenden Felder, um Kalender-Aktionen zu aktivieren.';
          block.appendChild(hint);
        }

        const container=document.createElement('div'); container.appendChild(block); html+=container.innerHTML;
        if(post) html+='<br>'+post;
        t=html;
      }
      return t.replace(/\n/g,'<br>');
    }

    function createMessageElement(msg){
      const row=document.createElement('div'); row.className=`message-row ${msg.sender==='user'?'user-message-row':'bot-message-row'}`;
      const cont=document.createElement('div'); cont.className='message-content';

      if(msg.imageUrl){ const img=document.createElement('img'); img.src=msg.imageUrl; img.alt='Vom Nutzer hochgeladenes Bild'; img.className='w-full max-h-64 object-contain rounded-xl mb-2 shadow-md'; cont.appendChild(img); }

      const textEl=document.createElement('div'); textEl.className=`message ${msg.sender==='user'?'user-message':'bot-message'}`;

      if(msg.sender==='model'){ currentInteraction=null; }

      let raw = msg.text;

      // Ensure <INTERACTION> tags are present
      if(!raw.includes('<INTERACTION>')){
        const loose = raw.match(/\{[\s\S]*"interactionType"[\s\S]*\}/);
        if(loose){ raw = raw.replace(loose[0], `<INTERACTION>${loose[0]}</INTERACTION>`); }
      }

      const iRx=/<INTERACTION>(.*?)<\/INTERACTION>/s; const iMatch=raw.match(iRx);
      if(msg.sender==='model' && iMatch){
        try{
          const data=JSON.parse(iMatch[1].trim());
          const prompt=data.message || data.prompt || 'Bitte wählen:';
          currentInteraction=data;
          
          textEl.innerHTML = formatMarkdownToHtml(prompt) + '<br>';

          const box=document.createElement('div'); 
          box.className='interactive-buttons';

          // Setze spezielle CSS-Klasse für Adress-Optionen (volle Breite)
          if(data.interactionType === 'ORT_SELECTION' || data.interactionType === 'ZWECK_SELECTION'){
              box.classList.add('full-width-options');
          }
          
          if(Array.isArray(data.options)){
            data.options.forEach(opt=>{
              // ROBUSTHEITS-FIX: Prüft auf Existenz, nutzt Value, Label oder Fallback.
              const label = (opt && opt.label) ? opt.label : (opt && opt.value) ? String(opt.value) : 'Option wählen';
              const value = (opt && opt.value !== undefined) ? opt.value : (opt && opt.label) ? opt.label : label;

              const b=document.createElement('button');
              b.type='button'; b.className='interactive-button';
              b.textContent = label;
              // FIX V18.0: Click-Handler ist hier, stellt sicher, dass Value gesendet wird.
              b.onclick = () => handleInteractiveResponse(value); 
              box.appendChild(b);
            });
          }
          
          // Manuelle Eingabe-Buttons hinzufügen (Immer am Ende)
          let manualButtonText = null;

          if(data.interactionType === 'ORT_SELECTION'){
              manualButtonText = 'Anderer Ort/Adresse: Bitte unten eingeben';
          } else if (data.interactionType === 'DAUER_SELECTION'){
              manualButtonText = 'Andere Dauer (z.B. 1:45): Bitte unten eingeben';
          } else if (data.interactionType === 'ZWECK_SELECTION'){
              manualButtonText = 'Anderer Zweck: Bitte unten eingeben';
          } else if (data.interactionType === 'REMINDER_SELECTION'){
              manualButtonText = 'Eigene Erinnerungszeit: Bitte unten eingeben';
          }

          if(manualButtonText){
              const manualInputButton = document.createElement('button');
              manualInputButton.type = 'button';
              // FIX V18.0: Neue CSS-Klasse für das Aussehen als Hinweis
              manualInputButton.className = 'interactive-button manual-input'; 
              manualInputButton.textContent = manualButtonText;
              manualInputButton.onclick = () => { 
                  currentInteraction = null;
                  userInput.focus();
                  toggleSendButton();
              };
              box.appendChild(manualInputButton); 
          }
          
          if(box.children.length > 0){
              textEl.appendChild(box); 
          }
          
          raw = raw.replace(iRx,'').trim();
        }catch(e){ console.error('Interaction JSON parse error', e); }
      }

      // FIX V18.0: Aggressiv alle verbleibenden JSON-Strukturen (wie das {..} unter dem Zweck) entfernen
      if(msg.sender==='model'){
          raw = raw.replace(/\{[\s\S]*\}/g, '').trim(); 
      }

      if(raw.length>0){ textEl.innerHTML += formatMarkdownToHtml(raw); }

      cont.appendChild(textEl); row.appendChild(cont);
      return row;
    }

    function addMessageToChat(text, sender, imageUrl=null){
      const data={ text, sender, imageUrl };
      chatHistory.push(data);
      if(chatWindow) chatWindow.appendChild(createMessageElement(data)); 
      saveChatHistory(); 
      scrollToBottom();
      return data;
    }

    function showLoading(){ if(loadingIndicator){ loadingIndicator.classList.remove('hidden'); scrollToBottom(); } }
    function hideLoading(){ if(loadingIndicator){ loadingIndicator.classList.add('hidden'); } }

    function resetImageUpload(){
      currentImageFile=null; if(fileInput) fileInput.value=''; if(imagePreviewContainer) imagePreviewContainer.classList.add('hidden');
      const p=document.getElementById('image-preview'); const f=document.getElementById('image-filename'); if(p) p.src=''; if(f) f.textContent='';
    }
    function fileToBase64(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.readAsDataURL(file); r.onload=()=>res(r.result.split(',')[1]); r.onerror=e=>rej(e); }); }

    async function sendApiRequest(userMessageText, userImageFile=null){
      const currentDate=new Date().toLocaleDateString('de-DE',{year:'numeric',month:'2-digit',day:'2-digit'});

      // SYSTEM PROMPT
      const systemPrompt=`Sie sind der 'AI Termin-Detektiv'. Das **HEUTIGE DATUM ist: ${currentDate}**. Extrahieren und pflegen Sie Datum (YYYY-MM-DD), Uhrzeit (HH:MM), Dauer (HH:MM), Ort (vollständige Adresse) und Zweck. Behalten Sie den Chatverlauf immer im Kontext. Nutzen Sie Google Search, um Adressen von Ärzten, Geschäften oder Orten zu finden.
Wenn Daten fehlen oder unklar sind, antworten Sie ausschließlich mit einem <INTERACTION>-Block im JSON-Format.

Spezifische Anweisungen für die interaktive Abfrage:
1.  **Fehlender Ort (ORT_SELECTION):**
    * Wenn ein Ort unklar ist (z.B. nur "Bretzenheim"), soll der 'message'-Text lauten: "**Ort**\\nDer Termin-Detektiv hat keine eindeutige Adresse erkannt. Geben Sie bitte unten die korrekte Adresse ein oder wählen Sie einen Vorschlag aus:". Fügen Sie 5 präzise Adressvorschläge (aus Google Search, z.B. von "Dr. Weber in Bretzenheim") als 'options' (mit label=Adresse, value=Adresse) hinzu.
    * Wenn ein Ort erkannt wurde (z.B. "Dr. Weber, Hauptstraße 10"), aber das Feld "Ort" als unvollständig gekennzeichnet ist, soll der 'message'-Text lauten: "**Ort**\\nDer Termin-Detektiv hat folgende Adresse erkannt: **[Erkannte Adresse]**. Falls Korrektur notwendig, geben Sie bitte unten die korrekte Adresse ein oder wählen Sie einen Vorschlag aus:". Fügen Sie 5 alternative Adressvorschläge (aus Google Search) als 'options' hinzu.
    * Wenn der Ort eindeutig erkannt wird und die Adresse vollständig ist, darf keine INTERACTION für ORT_SELECTION erfolgen.
2.  **Fehlende Dauer (DAUER_SELECTION):**
    * Der 'message'-Text soll lauten: "**Dauer**\\nBitte wählen Sie die voraussichtliche Dauer aus:". Fügen Sie 4 Dauer-Buttons hinzu mit festen Labels und Werten:
        * Label: "30 Min", Value: "0:30"
        * Label: "1 Stunde", Value: "1:00"
        * Label: "2 Stunden", Value: "2:00"
        * Label: "3 Stunden", Value: "3:00"
3.  **Fehlender Zweck (ZWECK_SELECTION):**
    * Der 'message'-Text soll lauten: "**Zweck**\\nBitte wählen Sie einen passenden Zweck aus:". Fügen Sie 5 intelligente, kontextbezogene Vorschläge als 'options' hinzu (z.B. bei Arzttermin: "Regelmäßige Kontrolle", "Blutabnahme", "Erstuntersuchung", "Folgetermin", "Impftermin").
4.  **Erinnerung (REMINDER_SELECTION, optional):**
    * Nachdem alle Hauptfelder (Datum, Uhrzeit, Dauer, Ort, Zweck) vollständig sind, fragen Sie optional: "**Erinnerung**\\nWann möchten Sie erinnert werden?". Fügen Sie 4 Vorschläge als 'options' hinzu (z.B. "30 Minuten davor", "1 Stunde davor", "2 Stunden davor", "3 Stunden davor").

Wenn alle Hauptfelder (Datum, Uhrzeit, Dauer, Ort, Zweck) vorliegen, liefern Sie zusätzlich:
<EXTRACT>
**Datum:** YYYY-MM-DD (formatierter Text)
**Uhrzeit:** HH:MM (formatierter Text)
**Dauer:** HH:MM (formatierter Text)
**Ort:** Adresse (formatierter Text)
**Zweck:** Text (formatierter Text)
<DATA>{"Datum":"YYYY-MM-DD","Uhrzeit":"HH:MM","Dauer":"HH:MM","Ort":"Adresse","Zweck":"Text"}</DATA>
</EXTRACT>
**WICHTIG:** Im JSON in <DATA> fehlende Felder als **"[FEHLT]"** kennzeichnen. **In der formatierten Textausgabe** innerhalb von <EXTRACT> fehlende Felder mit **einem einfachen Bindestrich** ("-") kennzeichnen. Antworten Sie auf Deutsch. Verwenden Sie im Format-Block descriptive/friendly text (z.B. "Dienstag, der 28.10.2025 (Nächsten Dienstag)") und nicht nur die rohen ISO-Werte.`;


      const historyForApi = chatHistory.map(m=>({ role:m.sender==='user'?'user':'model', parts:[{ text:m.text }] }));
      
      let parts=[{ text:userMessageText }];
      if(userImageFile){
        try{
          const base64=await fileToBase64(userImageFile);
          parts=[
            { text:`Analysiere das angehängte Bild und den Text ("${userMessageText}") und extrahiere/korrigiere die Termindaten. Beachte den gesamten Chatverlauf.` },
            { inlineData:{ mimeType:userImageFile.type, data:base64 } }
          ];
        }catch{ return { text:"Ein Fehler ist beim Hochladen des Bildes aufgetreten.", type:'error' }; }
      }

      const apiContents = [...historyForApi, { role:'user', parts }];

      const payload = { contents: apiContents, tools:[{ googleSearch:{} }], systemInstruction:{ parts:[{ text: systemPrompt }] } };

      if (!parts || !Array.isArray(parts) || parts.length === 0 || (!userMessageText && !userImageFile)) {
        return { text: "Bitte geben Sie eine Nachricht ein oder laden Sie ein Bild hoch.", type: "error" };
      }

      const resp = await fetch(API_ENDPOINT, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });

      const ct = resp.headers.get('content-type') || '';
      let data, raw;
      if (ct.includes('application/json')) data = await resp.json().catch(()=>null);
      else raw = await resp.text().catch(()=>'');

      if(!resp.ok){
        const msg = data?.error?.message || raw || resp.statusText;
        return { text: `Fehler (${resp.status}): ${msg}`, type:'error' };
      }

      const text = data?.candidates?.[0]?.content?.parts?.[0]?.text || raw || "Keine Antwort erhalten.";
      return { text, type:'success' };
    }

    async function handleChatFlow(userMessageText, userImageFile=null){
      if(!userMessageText && !userImageFile) return;
      showLoading();
      try{
        const response = await sendApiRequest(userMessageText, userImageFile);
        addMessageToChat(response.text, response.type === 'error' ? 'system' : 'model');
      } finally {
        hideLoading();
        toggleSendButton();
      }
    }

    async function sendMessage(){
      const text = userInput.value.trim();
      const imageFile = currentImageFile;
      if(!text && !imageFile) return;

      const userImageUrl = imageFile ? URL.createObjectURL(imageFile) : null;
      sendButton.disabled = true;
      addMessageToChat(text || "(Bild gesendet)", 'user', userImageUrl);

      userInput.value = '';
      userInput.style.height = 'auto';
      resetImageUpload();
      toggleSendButton();

      // Bei aktiver Interaktion wird der Text als Interaktions-Antwort gesendet
      const messageToSend = currentInteraction && !imageFile ? `**Interaktive Korrektur/Ergänzung:** Feld (${currentInteraction.interactionType}) = **${text}**. Aktualisiere den Termin-Entwurf.` : text;
      
      currentInteraction = null;

      await handleChatFlow(messageToSend, imageFile);
    }

    async function handleInteractiveResponse(value){
      if(!currentInteraction) return;
      // FIX V18.0: Sicherstellen, dass der Wert als String verarbeitet wird
      const v = String(value||"").trim(); 
      if(!v) return;

      const interaction = currentInteraction;
      addMessageToChat(`(Korrigiert/Ergänzt: ${v})`, 'user');

      currentInteraction = null;
      toggleSendButton();

      const msg = `**Interaktive Korrektur/Ergänzung:** Feld (${interaction.interactionType}) = **${v}**. Aktualisiere den Termin-Entwurf.`;
      await handleChatFlow(msg);
    }

    function initializeChat(){
      chatWindow = document.getElementById('chatWindow');
      userInput = document.getElementById('userInput');
      sendButton = document.getElementById('sendButton');
      downloadChatButton = document.getElementById('downloadChatButton');
      clearChatButton = document.getElementById('clearChatButton'); 
      fileInput = document.getElementById('fileInput');
      imagePreviewContainer = document.getElementById('imagePreviewContainer');
      loadingIndicator = document.getElementById('loadingIndicator');

      if(!chatWindow || !userInput || !sendButton){ console.error('FEHLER: Kritische DOM-Elemente fehlen!'); return; }

      currentInteraction = null;
      currentImageFile = null;
      userInput.value = '';
      sendButton.disabled = true;
      userInput.disabled = false;

      loadChatHistory(); 

      if(chatHistory.length===0){
        const welcome = "Willkommen beim **AI Termin-Detektiv**! Das heutige Datum ist der **" + new Date().toLocaleDateString('de-DE') + "**. Senden Sie Text, einen Screenshot oder ein Foto; fehlende Details werden interaktiv abgefragt. Sie können jederzeit tippen oder die Vorschläge wählen.";
        addMessageToChat(welcome, 'model');
      }

      userInput.addEventListener('input', ()=>{
        userInput.style.height='auto';
        userInput.style.height=userInput.scrollHeight+'px';
        toggleSendButton();
      });
      userInput.addEventListener('keydown', (e)=>{
        if(e.key==='Enter' && !e.shiftKey){
          e.preventDefault();
          if(!sendButton.disabled){ sendMessage(); }
        }
      });

      fileInput.addEventListener('change', (e)=>{
        const file=e.target.files[0];
        if(file && file.type.startsWith('image/')){
          currentImageFile=file;
          document.getElementById('image-preview').src=URL.createObjectURL(file);
          document.getElementById('image-filename').textContent=file.name;
          imagePreviewContainer.classList.remove('hidden');
        } else {
          resetImageUpload();
        }
        toggleSendButton();
      });
      document.getElementById('cancel-upload').addEventListener('click', ()=>{
        resetImageUpload();
        toggleSendButton();
      });

      sendButton.addEventListener('click', sendMessage);
      
      if (clearChatButton) {
        clearChatButton.addEventListener('click', clearChatHistory);
      }

      downloadChatButton.addEventListener('click', ()=>{
        const chatText = chatHistory.map(m => `${m.sender.toUpperCase()}: ${m.text}`).join('\n\n');
        const blob = new Blob([chatText], { type:'text/plain;charset=utf-8' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `chat_export_${Date.now()}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      });

      toggleSendButton();
    }

    if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', initializeChat); } else { initializeChat(); }
  </script>
</body>
</html>
