<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI Termin-Detektiv Interaktiv V16 (Netlify + Robust)</title>

  <!-- Tailwind CSS + Material Icons -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
    html, body { height: 100%; margin: 0; }
    body { font-family: 'Inter', sans-serif; background-color: #f7f7f7; }

    .chat-container { display:flex; flex-direction:column; height:100vh; max-height:100vh; overflow:hidden; }
    .chat-window { flex-grow:1; overflow-y:auto; scroll-behavior:smooth; padding:1rem; background-color:#fff; }
    .message-row { display:flex; margin-bottom:0.75rem; }
    .user-message-row { justify-content:flex-end; }
    .bot-message-row { justify-content:flex-start; }
    .message-content { display:flex; flex-direction:column; max-width:85%; }

    .message { padding:0.75rem 1rem; border-radius:1.5rem; line-height:1.4; word-wrap:break-word; font-size:0.95rem; box-shadow:0 1px 3px rgba(0,0,0,0.1); }
    .user-message { background-color:#DCF8C6; color:#1F2937; border-bottom-right-radius:0.375rem; }
    .bot-message { background-color:#E5E7EB; color:#1F2937; border-bottom-left-radius:0.375rem; }

    .extraction-block { background:#F9FAFB; border:1px solid #D1D5DB; padding:1rem; margin-top:0.75rem; border-radius:0.75rem; box-shadow:0 2px 4px rgba(0,0,0,0.05); font-size:0.9rem; }
    .extraction-block strong { color:#4338CA; }

    .loading-dots div { width:10px; height:10px; background-color:#4B5563; border-radius:50%; display:inline-block; margin:0 2px; animation:bounce 0.6s infinite alternate; }
    .loading-dots div:nth-child(2){ animation-delay:0.2s; }
    .loading-dots div:nth-child(3){ animation-delay:0.4s; }
    @keyframes bounce { from{ transform:translateY(0);} to{ transform:translateY(-5px);} }

    .interactive-buttons { display:flex; flex-direction:column; gap:8px; margin-top:1rem; padding-top:0.5rem; }
    .interactive-button {
      display:flex; align-items:center; justify-content:center; gap:8px; width:100%;
      background:#10B981; color:#fff; padding:10px 14px; border-radius:0.75rem; font-size:0.9rem; font-weight:600;
      cursor:pointer; transition:background-color .2s, transform .05s; box-shadow:0 1px 3px rgba(0,0,0,0.15);
    }
    .interactive-button:hover { background:#059669; }
    .interactive-button:active { transform:scale(0.99); }

    .calendar-actions { display:flex; flex-direction:column; gap:8px; margin-top:1rem; padding-top:1rem; border-top:1px dashed #D1D5DB; }
    .calendar-button { display:flex; align-items:center; justify-content:center; gap:8px; padding:12px; border-radius:0.75rem; font-weight:600; transition:background-color .2s, transform .05s; width:100%; }
    .calendar-button .material-icons { font-size:18px; line-height:1; vertical-align:middle; }
    .calendar-button:active { transform:scale(0.99); }
    .ics-button { background:#EF4444; color:#fff; }
    .ics-button:hover { background:#DC2626; }
    .google-button { background:#4285F4; color:#fff; }
    .google-button:hover { background:#3B7AEB; }
  </style>
</head>
<body class="bg-gray-50">
  <div id="app" class="chat-container">
    <header class="bg-white shadow-md p-4 flex justify-between items-center sticky top-0 z-10 flex-shrink-0">
      <h1 class="text-xl font-bold text-gray-800 flex items-center gap-2">
        <span class="material-icons text-indigo-600 align-middle" style="font-size:22px; line-height:1;">calendar_today</span>
        AI Termin-Detektiv
      </h1>
      <button id="downloadChatButton"
        class="flex items-center justify-center gap-2 bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-3 rounded-xl transition duration-150 ease-in-out shadow-lg text-sm">
        <span class="material-icons align-middle" style="font-size:18px; line-height:1;">download</span>
        <span>Chat Export</span>
      </button>
    </header>

    <div id="chatWindow" class="chat-window flex flex-col space-y-3"></div>

    <div id="loadingIndicator" class="hidden p-4 bg-white flex-shrink-0">
      <div class="bot-message-row">
        <div class="message bg-gray-200 text-gray-700 flex items-center">
          <div class="loading-dots flex"><div></div><div></div><div></div></div>
        </div>
      </div>
    </div>

    <div class="message-input-area p-4 bg-gray-100 border-t border-gray-200 flex-shrink-0">
      <div id="imagePreviewContainer" class="image-preview-container flex items-center justify-between mb-3 hidden">
        <div class="flex items-center space-x-3">
          <img id="image-preview" src="" alt="Bild-Vorschau" class="h-20 w-auto rounded-lg object-cover" />
          <span id="image-filename" class="text-sm text-gray-600 truncate max-w-xs"></span>
        </div>
        <button id="cancel-upload" class="flex items-center justify-center text-gray-600 hover:text-red-600 transition duration-150">
          <span class="material-icons align-middle" style="font-size:20px; line-height:1;">close</span>
        </button>
      </div>

      <div class="flex items-end space-x-3">
        <label for="fileInput" class="cursor-pointer text-gray-600 hover:text-indigo-600 transition duration-150 p-2 rounded-full hover:bg-gray-200 flex items-center justify-center">
          <span class="material-icons align-middle" style="font-size:28px; line-height:1;">image</span>
          <input type="file" id="fileInput" accept="image/*" class="hidden" />
        </label>

        <textarea id="userInput" placeholder="Termin-Details eingeben..." rows="1"
          class="flex-grow resize-none p-3 border border-gray-300 rounded-2xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 overflow-hidden"
          style="max-height:200px;"></textarea>

        <button id="sendButton" disabled
          class="flex items-center justify-center gap-2 bg-indigo-500 text-white p-3 rounded-full shadow-lg transition-all duration-300 disabled:bg-indigo-300 disabled:opacity-70 hover:bg-indigo-600">
          <span class="material-icons align-middle" style="font-size:18px; line-height:1;">send</span>
          <span class="hidden sm:inline">Senden</span>
        </button>
      </div>
    </div>
  </div>

  <script type="module">
    // Endpoint über Netlify Functions (Proxy, kein API-Key im Client)
    const API_ENDPOINT = "/.netlify/functions/gemini";

    const STORAGE_KEY = 'terminDetektivChatHistory';

    let chatHistory = [];
    let currentImageFile = null;
    let currentInteraction = null;

    let chatWindow, userInput, sendButton, downloadChatButton, fileInput, imagePreviewContainer, loadingIndicator;

    function saveChatHistory(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(chatHistory)); }catch(e){ console.error(e); } }
    function loadChatHistory(){ try{ const s=localStorage.getItem(STORAGE_KEY); if(s){ chatHistory=JSON.parse(s); renderChatHistory(); } }catch(e){ console.error(e); } }

    function renderChatHistory(){
      if(!chatWindow) return;
      chatWindow.innerHTML='';
      currentInteraction=null;
      chatHistory.forEach(m=> chatWindow.appendChild(createMessageElement(m)));
      scrollToBottom();
      toggleSendButton();
    }

    function durationToMinutes(d){ if(!d || d.includes('[FEHLT]')) return 60; const p=d.split(':'); return p.length===2 ? (+p[0])*60+(+p[1]) : 60; }
    function calculateEndTime(date,time,dur){
      if(!time || time.includes('[FEHLT]')) return date.replace(/-/g,'')+'T235959';
      const start=new Date(date+'T'+time+':00'); const end=new Date(start.getTime()+dur*60000);
      const y=end.getFullYear(), m=String(end.getMonth()+1).padStart(2,'0'), d_=String(end.getDate()).padStart(2,'0');
      const hh=String(end.getHours()).padStart(2,'0'), mm=String(end.getMinutes()).padStart(2,'0');
      return `${y}${m}${d_}T${hh}${mm}00`;
    }
    function createGoogleCalendarLink(data){
      const title=encodeURIComponent(data.Zweck||'Termin');
      const location=encodeURIComponent(data.Ort||'');
      const datePart=(data.Datum||'').replace(/-/g,''); const dur=durationToMinutes(data.Dauer||'[FEHLT]');
      let startDate,endDate;
      if(!data.Uhrzeit || data.Uhrzeit.includes('[FEHLT]')){ startDate=datePart; const s=new Date(data.Datum); const e=new Date(s); e.setDate(s.getDate()+1); endDate=e.toISOString().split('T')[0].replace(/-/g,''); }
      else { const st=data.Uhrzeit.replace(/:/g,'')+'00'; startDate=datePart+'T'+st; endDate=calculateEndTime(data.Datum,data.Uhrzeit,dur); }
      return `https://www.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${startDate}/${endDate}&location=${location}&sf=true&output=xml`;
    }
    function createICSContent(data){
      const uid=Date.now(); const now=new Date().toISOString().replace(/[-:]/g,'').split('.')[0]+'Z';
      const summary=data.Zweck||'Termin', location=data.Ort||'', datePart=(data.Datum||'').replace(/-/g,''), dur=durationToMinutes(data.Dauer||'[FEHLT]');
      let dtstart, dtend;
      if(!data.Uhrzeit || data.Uhrzeit.includes('[FEHLT]')){
        dtstart=`DTSTART;VALUE=DATE:${datePart}`;
        const s=new Date(data.Datum+'T00:00:00'); const e=new Date(s); e.setDate(s.getDate()+1);
        dtend=`DTEND;VALUE=DATE:${e.toISOString().split('T')[0].replace(/-/g,'')}`;
      } else {
        const st=data.Uhrzeit.replace(/:/g,'')+'00';
        const et=calculateEndTime(data.Datum,data.Uhrzeit,dur).split('T')[1];
        dtstart=`DTSTART:${datePart}T${st}`; dtend=`DTEND:${datePart}T${et}`;
      }
      return ['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//AI Termin-Detektiv//NONSGML v1.0//DE','BEGIN:VEVENT',`UID:${uid}@termin-detektiv.de`,`DTSTAMP:${now}`,dtstart,dtend,`SUMMARY:${summary}`,`LOCATION:${location}`,'END:VEVENT','END:VCALENDAR'].join('\r\n');
    }
    function downloadICS(c){ const blob=new Blob([c],{type:'text/calendar;charset=utf-8'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`termin_${Date.now()}.ics`; document.body.appendChild(a); a.click(); document.body.removeChild(a); }

    function scrollToBottom(){ if(!chatWindow) return; setTimeout(()=>{ chatWindow.scrollTop=chatWindow.scrollHeight; },10); }
    function toggleSendButton(){
      if(!sendButton||!userInput) return;
      const text=userInput.value.trim(); const hasImage=currentImageFile!==null; const hasInput=Boolean(text)||hasImage; const isInteracting=currentInteraction!==null;
      sendButton.disabled=!hasInput; userInput.disabled=isInteracting;
      userInput.placeholder=isInteracting?'Bitte wählen Sie eine Option oder geben Sie die Antwort direkt ein...':'Termin-Details eingeben...';
    }

    function formatMarkdownToHtml(raw){
      let t = raw.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\*(.*?)\*/g,'<em>$1</em>');
      if(!t.includes('<INTERACTION>')){
        const loose = t.match(/\{[\s\S]*"interactionType"[\s\S]*\}/);
        if(loose){ t = t.replace(loose[0], `<INTERACTION>${loose[0]}</INTERACTION>`); }
      }
      const rx=/<EXTRACT>(.*?)<DATA>(.*?)<\/DATA><\/EXTRACT>/s; const m=t.match(rx);
      if(m){
        const extraction=m[1].trim(); const rawJson=m[2].trim();
        const pre=t.substring(0,m.index).trim().replace(/\n/g,'<br>'); const post=t.substring(m.index+m[0].
